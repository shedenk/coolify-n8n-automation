n8n:
  image: n8nio/n8n:1.113.3
  container_name: n8n-automation
  command: >
    sh -c "
      echo 'ðŸ”§ Installing tools...' &&
      apk add --no-cache curl ffmpeg python3 py3-pip pandoc qpdf chromium nss freetype harfbuzz ca-certificates ttf-freefont groff less &&
      pip3 install --break-system-packages newspaper4k awscli &&
      curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp &&
      chmod +x /usr/local/bin/yt-dlp &&
      npm install -g puppeteer &&
      mkdir -p /root/.aws &&
      echo '[default]' > /root/.aws/config &&
      echo 'region = us-east-1' >> /root/.aws/config &&
      echo 'output = json' >> /root/.aws/config &&
      export AWS_ACCESS_KEY_ID=minioadmin &&
      export AWS_SECRET_ACCESS_KEY=minioadmin &&
      export AWS_DEFAULT_REGION=us-east-1 &&
      export AWS_ENDPOINT_URL=http://minio:9000 &&
      export CHROME_BIN=/usr/bin/chromium-browser &&
      export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser &&
      echo 'âœ… Tools installed. Starting n8n...' &&
      exec n8n
    "
  ports:
    - "5678:5678"
  environment:
    - N8N_BASIC_AUTH_ACTIVE=true
    - N8N_BASIC_AUTH_USER=admin
    - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-yourpassword}
    - N8N_PROTOCOL=http
    - N8N_HOST=0.0.0.0
    - N8N_PORT=5678
    - N8N_WEBHOOK_URL=http://localhost:5678/webhook/
  volumes:
    - n8n_/home/node/.n8n
    - ./downloads:/downloads
  restart: unless-stopped
  networks:
    - app-network
  # Optional: healthcheck
  healthcheck:
    test:
      [
        "CMD",
        "wget",
        "--quiet",
        "--tries=1",
        "--spider",
        "http://localhost:5678",
      ]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 120s
